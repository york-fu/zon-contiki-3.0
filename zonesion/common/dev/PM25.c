/*********************************************************************************************
* 文件：PM25.c
* 作者：zonesion 2017.02.17
* 说明:PM2.5驱动程序
* 修改：Chenkm 2017.02.17 添加注释
* 注释：
*
*********************************************************************************************/
/*********************************************************************************************
* 头文件
*********************************************************************************************/
#include <stdio.h>

/*********************************************************************************************
* 全局变量
*********************************************************************************************/
float PM1_0, PM2_5, PM10;

/*********************************************************************************************
* 名称:pm25_read_byte()
* 功能:PM2.5读取字节数据
* 参数:char c -- 读取到的数据
* 返回:无
* 修改:
* 注释:
*********************************************************************************************/
void pm25_read_byte(char c)
{
  static char buf[32];
  static int status = 0;
  static int pkg_len = 0;
  static int offset = 0;
  if (status == 0 && c == 0x42) status = 1;
  else if (status == 1 && c == 0x4d) status = 2;
  else if (status == 2) {
      pkg_len = c;
      status = 3;
  }else if (status == 3) {
      pkg_len = (pkg_len<<8) | c;
      status = 4;
  }else if (status == 4) {
    buf[offset++] = c;
    if (offset == pkg_len) {
      PM1_0 = buf[0]<<8 | buf[1];
      PM2_5 = buf[2]<<8 | buf[3];
      PM10 = buf[4]<<8 | buf[5];
      pkg_len = 0;
      offset = 0;
      status = 0;
    } 
  } else {
    status = 0;
    offset = 0;
    pkg_len = 0;
  }
}